<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MLIR: lib/Dialect/GPU/Transforms/MemoryPromotion.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MLIR
   &#160;<span id="projectnumber">12.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_1a25ec519b6c1121408b67cc33ce3f15.html">Dialect</a></li><li class="navelem"><a class="el" href="dir_3f85108297f05fdb2e5b01bdfbaaf2c9.html">GPU</a></li><li class="navelem"><a class="el" href="dir_d0630226ae28c2cccac15992b4322212.html">Transforms</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">MemoryPromotion.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="MemoryPromotion_8h_source.html">mlir/Dialect/GPU/MemoryPromotion.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="GPUDialect_8h_source.html">mlir/Dialect/GPU/GPUDialect.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="Dialect_2SCF_2EDSC_2Builders_8h_source.html">mlir/Dialect/SCF/EDSC/Builders.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="StandardOps_2EDSC_2Intrinsics_8h_source.html">mlir/Dialect/StandardOps/EDSC/Intrinsics.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="Pass_2Pass_8h_source.html">mlir/Pass/Pass.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="LoopUtils_8h_source.html">mlir/Transforms/LoopUtils.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for MemoryPromotion.cpp:</div>
<div class="dyncontent">
<div class="center"><img src="MemoryPromotion_8cpp__incl.png" border="0" usemap="#lib_2Dialect_2GPU_2Transforms_2MemoryPromotion_8cpp" alt=""/></div>
<map name="lib_2Dialect_2GPU_2Transforms_2MemoryPromotion_8cpp" id="lib_2Dialect_2GPU_2Transforms_2MemoryPromotion_8cpp">
<area shape="rect" id="node2" href="MemoryPromotion_8h.html" title="mlir/Dialect/GPU/MemoryPromotion.h" alt="" coords="2261,102,2504,129"/>
<area shape="rect" id="node3" href="GPUDialect_8h.html" title="mlir/Dialect/GPU/GPUDialect.h" alt="" coords="857,273,1063,300"/>
<area shape="rect" id="node31" href="Dialect_2SCF_2EDSC_2Builders_8h.html" title="mlir/Dialect/SCF/EDSC\l/Builders.h" alt="" coords="2579,184,2741,225"/>
<area shape="rect" id="node41" href="StandardOps_2EDSC_2Intrinsics_8h.html" title="mlir/Dialect/StandardOps\l/EDSC/Intrinsics.h" alt="" coords="2760,95,2928,136"/>
<area shape="rect" id="node43" href="Pass_2Pass_8h.html" title="mlir/Pass/Pass.h" alt="" coords="3108,191,3231,218"/>
<area shape="rect" id="node50" href="LoopUtils_8h.html" title="mlir/Transforms/LoopUtils.h" alt="" coords="3546,445,3729,471"/>
<area shape="rect" id="node4" href="IR_2Dialect_8h.html" title="mlir/IR/Dialect.h" alt="" coords="1409,445,1527,471"/>
<area shape="rect" id="node12" href="FunctionSupport_8h.html" title="mlir/IR/FunctionSupport.h" alt="" coords="2061,355,2232,382"/>
<area shape="rect" id="node13" href="OpDefinition_8h.html" title="mlir/IR/OpDefinition.h" alt="" coords="1775,445,1923,471"/>
<area shape="rect" id="node19" href="OpImplementation_8h.html" title="mlir/IR/OpImplementation.h" alt="" coords="566,355,749,382"/>
<area shape="rect" id="node24" href="SymbolTable_8h.html" title="mlir/IR/SymbolTable.h" alt="" coords="2453,355,2605,382"/>
<area shape="rect" id="node27" href="SideEffectInterfaces_8h.html" title="mlir/Interfaces/SideEffect\lInterfaces.h" alt="" coords="875,348,1045,389"/>
<area shape="rect" id="node5" href="OperationSupport_8h.html" title="mlir/IR/OperationSupport.h" alt="" coords="2182,601,2359,628"/>
<area shape="rect" id="node10" href="TypeID_8h.html" title="mlir/Support/TypeID.h" alt="" coords="1955,527,2106,553"/>
<area shape="rect" id="node6" href="Attributes_8h.html" title="mlir/IR/Attributes.h" alt="" coords="2143,676,2275,703"/>
<area shape="rect" id="node8" href="Types_8h.html" title="mlir/IR/Types.h" alt="" coords="2799,676,2911,703"/>
<area shape="rect" id="node9" href="TypeSupport_8h.html" title="mlir/IR/TypeSupport.h" alt="" coords="2779,758,2930,785"/>
<area shape="rect" id="node11" href="LLVM_8h.html" title="mlir/Support/LLVM.h" alt="" coords="3223,601,3364,628"/>
<area shape="rect" id="node14" href="Operation_8h.html" title="mlir/IR/Operation.h" alt="" coords="1791,527,1923,553"/>
<area shape="rect" id="node15" href="Block_8h.html" title="mlir/IR/Block.h" alt="" coords="2648,601,2757,628"/>
<area shape="rect" id="node20" href="DialectInterface_8h.html" title="mlir/IR/DialectInterface.h" alt="" coords="1217,445,1385,471"/>
<area shape="rect" id="node32" href="SCF_8h.html" title="mlir/Dialect/SCF/SCF.h" alt="" coords="1483,273,1645,300"/>
<area shape="rect" id="node33" href="IR_2Builders_8h.html" title="mlir/IR/Builders.h" alt="" coords="2256,355,2379,382"/>
<area shape="rect" id="node38" href="EDSC_2Builders_8h.html" title="mlir/EDSC/Builders.h" alt="" coords="2863,273,3009,300"/>
<area shape="rect" id="node34" href="ControlFlowInterfaces_8h.html" title="mlir/Interfaces/ControlFlow\lInterfaces.h" alt="" coords="1672,348,1851,389"/>
<area shape="rect" id="node35" href="LoopLikeInterface_8h.html" title="mlir/Interfaces/LoopLike\lInterface.h" alt="" coords="1875,348,2037,389"/>
<area shape="rect" id="node39" href="AffineExpr_8h.html" title="mlir/IR/AffineExpr.h" alt="" coords="2979,445,3117,471"/>
<area shape="rect" id="node40" href="StandardTypes_8h.html" title="mlir/IR/StandardTypes.h" alt="" coords="2833,601,2997,628"/>
<area shape="rect" id="node42" href="Dialect_2StandardOps_2EDSC_2Builders_8h.html" title="mlir/Dialect/StandardOps\l/EDSC/Builders.h" alt="" coords="2823,184,2991,225"/>
<area shape="rect" id="node44" href="Function_8h.html" title="mlir/IR/Function.h" alt="" coords="2466,273,2593,300"/>
<area shape="rect" id="node45" href="AnalysisManager_8h.html" title="mlir/Pass/AnalysisManager.h" alt="" coords="3197,527,3389,553"/>
<area shape="rect" id="node46" href="PassRegistry_8h.html" title="mlir/Pass/PassRegistry.h" alt="" coords="2668,273,2839,300"/>
<area shape="rect" id="node47" href="LogicalResult_8h.html" title="mlir/Support/LogicalResult.h" alt="" coords="3413,527,3600,553"/>
</map>
</div>
</div>
<p><a href="MemoryPromotion_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9d4d3ab88a1bd0148613478d2838abd0"><td class="memItemLeft" align="right" valign="top">static StringRef&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="MemoryPromotion_8cpp.html#a9d4d3ab88a1bd0148613478d2838abd0">getDimName</a> (unsigned dim)</td></tr>
<tr class="memdesc:a9d4d3ab88a1bd0148613478d2838abd0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns the textual name of a GPU dimension.  <a href="#a9d4d3ab88a1bd0148613478d2838abd0">More...</a><br /></td></tr>
<tr class="separator:a9d4d3ab88a1bd0148613478d2838abd0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5b2b219061813c55c406113dee5559ae"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="MemoryPromotion_8cpp.html#a5b2b219061813c55c406113dee5559ae">insertCopyLoops</a> (<a class="el" href="classmlir_1_1OpBuilder.html">OpBuilder</a> &amp;builder, <a class="el" href="classmlir_1_1Location.html">Location</a> loc, <a class="el" href="classmlir_1_1edsc_1_1MemRefBoundsCapture.html">MemRefBoundsCapture</a> &amp;bounds, <a class="el" href="classmlir_1_1Value.html">Value</a> from, <a class="el" href="classmlir_1_1Value.html">Value</a> to)</td></tr>
<tr class="memdesc:a5b2b219061813c55c406113dee5559ae"><td class="mdescLeft">&#160;</td><td class="mdescRight">Emits the (imperfect) loop nest performing the copy between "from" and "to" values using the bounds derived from the "from" value.  <a href="#a5b2b219061813c55c406113dee5559ae">More...</a><br /></td></tr>
<tr class="separator:a5b2b219061813c55c406113dee5559ae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f49d7c16b3b6670dcc63b492d879318"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="MemoryPromotion_8cpp.html#a3f49d7c16b3b6670dcc63b492d879318">insertCopies</a> (<a class="el" href="classmlir_1_1Region.html">Region</a> &amp;region, <a class="el" href="classmlir_1_1Location.html">Location</a> loc, <a class="el" href="classmlir_1_1Value.html">Value</a> from, <a class="el" href="classmlir_1_1Value.html">Value</a> to)</td></tr>
<tr class="memdesc:a3f49d7c16b3b6670dcc63b492d879318"><td class="mdescLeft">&#160;</td><td class="mdescRight">Emits the loop nests performing the copy to the designated location in the beginning of the region, and from the designated location immediately before the terminator of the first block of the region.  <a href="#a3f49d7c16b3b6670dcc63b492d879318">More...</a><br /></td></tr>
<tr class="separator:a3f49d7c16b3b6670dcc63b492d879318"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a9d4d3ab88a1bd0148613478d2838abd0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9d4d3ab88a1bd0148613478d2838abd0">&#9670;&nbsp;</a></span>getDimName()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static StringRef getDimName </td>
          <td>(</td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>dim</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns the textual name of a GPU dimension. </p>

<p class="definition">Definition at line <a class="el" href="MemoryPromotion_8cpp_source.html#l00027">27</a> of file <a class="el" href="MemoryPromotion_8cpp_source.html">MemoryPromotion.cpp</a>.</p>

<p class="reference">Referenced by <a class="el" href="MemoryPromotion_8cpp_source.html#l00043">insertCopyLoops()</a>.</p>

</div>
</div>
<a id="a3f49d7c16b3b6670dcc63b492d879318"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f49d7c16b3b6670dcc63b492d879318">&#9670;&nbsp;</a></span>insertCopies()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void insertCopies </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Region.html">Region</a> &amp;&#160;</td>
          <td class="paramname"><em>region</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Location.html">Location</a>&#160;</td>
          <td class="paramname"><em>loc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Value.html">Value</a>&#160;</td>
          <td class="paramname"><em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Value.html">Value</a>&#160;</td>
          <td class="paramname"><em>to</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Emits the loop nests performing the copy to the designated location in the beginning of the region, and from the designated location immediately before the terminator of the first block of the region. </p>
<p>The region is expected to have one block. This boils down to the following structure</p>
<p>^bb(...): &lt;loop-bound-computation&gt; for arg0 = ... to ... step ... { ... for argN = &lt;thread-id-x&gt; to ... step &lt;block-dim-x&gt; { %0 = load from[arg0, ..., argN] store %0, to[arg0, ..., argN] } ... } gpu.barrier &lt;... original body ...&gt; gpu.barrier for arg0 = ... to ... step ... { ... for argN = &lt;thread-id-x&gt; to ... step &lt;block-dim-x&gt; { %1 = load to[arg0, ..., argN] store %1, from[arg0, ..., argN] } ... }</p>
<p>Inserts the barriers unconditionally since different threads may be copying values and reading them. An analysis would be required to eliminate barriers in case where value is only used by the thread that copies it. Both copies are inserted unconditionally, an analysis would be required to only copy live-in and live-out values when necessary. This copies the entire memref pointed to by "from". In case a smaller block would be sufficient, the caller can create a subview of the memref and promote it instead. </p>

<p class="definition">Definition at line <a class="el" href="MemoryPromotion_8cpp_source.html#l00134">134</a> of file <a class="el" href="MemoryPromotion_8cpp_source.html">MemoryPromotion.cpp</a>.</p>

<p class="reference">References <a class="el" href="Block_8h_source.html#l00126">mlir::Block::back()</a>, <a class="el" href="Types_8h_source.html#l00328">mlir::Type::cast()</a>, <a class="el" href="Types_8h_source.html#l00322">mlir::Type::dyn_cast()</a>, <a class="el" href="IR_2Region_8h_source.html#l00061">mlir::Region::front()</a>, <a class="el" href="StandardTypes_8cpp_source.html#l00379">mlir::MemRefType::get()</a>, <a class="el" href="IR_2Region_8cpp_source.html#l00024">mlir::Region::getContext()</a>, <a class="el" href="StandardTypes_8cpp_source.html#l00455">mlir::MemRefType::getShape()</a>, <a class="el" href="Value_8cpp_source.html#l00034">mlir::Value::getType()</a>, <a class="el" href="MemoryPromotion_8cpp_source.html#l00043">insertCopyLoops()</a>, <a class="el" href="namespacemlir.html#a7173c36d6b113dcdb0599eb672526b43">mlir::promoteToWorkgroupMemory()</a>, <a class="el" href="Value_8cpp_source.html#l00124">mlir::Value::replaceAllUsesWith()</a>, and <a class="el" href="IR_2Builders_8h_source.html#l00331">mlir::OpBuilder::setInsertionPointToStart()</a>.</p>

</div>
</div>
<a id="a5b2b219061813c55c406113dee5559ae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5b2b219061813c55c406113dee5559ae">&#9670;&nbsp;</a></span>insertCopyLoops()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void insertCopyLoops </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classmlir_1_1OpBuilder.html">OpBuilder</a> &amp;&#160;</td>
          <td class="paramname"><em>builder</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Location.html">Location</a>&#160;</td>
          <td class="paramname"><em>loc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1edsc_1_1MemRefBoundsCapture.html">MemRefBoundsCapture</a> &amp;&#160;</td>
          <td class="paramname"><em>bounds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Value.html">Value</a>&#160;</td>
          <td class="paramname"><em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classmlir_1_1Value.html">Value</a>&#160;</td>
          <td class="paramname"><em>to</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Emits the (imperfect) loop nest performing the copy between "from" and "to" values using the bounds derived from the "from" value. </p>
<p>Emits at least GPUDialect::getNumWorkgroupDimensions() loops, completing the nest with single-iteration loops. Maps the innermost loops to thread dimensions, in reverse order to enable access coalescing in the innermost loop. </p>

<p class="definition">Definition at line <a class="el" href="MemoryPromotion_8cpp_source.html#l00043">43</a> of file <a class="el" href="MemoryPromotion_8cpp_source.html">MemoryPromotion.cpp</a>.</p>

<p class="reference">References <a class="el" href="IR_2Builders_8h_source.html#l00376">mlir::OpBuilder::create()</a>, <a class="el" href="Matchers_8h_source.html#l00185">mlir::detail::enumerate()</a>, <a class="el" href="MemoryPromotion_8cpp_source.html#l00027">getDimName()</a>, <a class="el" href="IR_2Builders_8cpp_source.html#l00053">mlir::Builder::getIndexType()</a>, <a class="el" href="Dialect_2StandardOps_2EDSC_2Builders_8h_source.html#l00037">mlir::edsc::BoundsCapture::getLbs()</a>, <a class="el" href="IR_2Region_8cpp_source.html#l00051">mlir::Region::getParentOp()</a>, <a class="el" href="Value_8cpp_source.html#l00088">mlir::Value::getParentRegion()</a>, <a class="el" href="Dialect_2StandardOps_2EDSC_2Builders_8h_source.html#l00039">mlir::edsc::BoundsCapture::getSteps()</a>, <a class="el" href="IR_2Builders_8cpp_source.html#l00198">mlir::Builder::getStringAttr()</a>, <a class="el" href="Dialect_2StandardOps_2EDSC_2Builders_8h_source.html#l00038">mlir::edsc::BoundsCapture::getUbs()</a>, <a class="el" href="Dialect_2SCF_2EDSC_2Builders_8cpp_source.html#l00018">mlir::edsc::loopNestBuilder()</a>, <a class="el" href="LoopUtils_8cpp_source.html#l01512">mlir::mapLoopToProcessorIds()</a>, and <a class="el" href="Dialect_2StandardOps_2EDSC_2Builders_8h_source.html#l00022">mlir::edsc::BoundsCapture::rank()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MemoryPromotion_8cpp_source.html#l00134">insertCopies()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 8 2020 16:27:18 for MLIR by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
